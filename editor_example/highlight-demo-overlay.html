<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ä¼ªå…ƒç´ è¦†ç›–å±‚å®ç°åœ†è§’é«˜äº®</title>
  <style>
    body {
      font-family: system-ui;
      padding: 40px;
      font-size: 18px;
      line-height: 2;
    }

    .editor-container {
      position: relative;
    }

    #editor {
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 8px;
      min-height: 100px;
      outline: none;
    }

    /* è¦†ç›–å±‚æ ·å¼ - åœ†è§’è¾¹æ¡†ï¼ */
    .highlight-overlay {
      position: absolute;
      pointer-events: none;  /* ç©¿é€ï¼Œä¸å½±å“ç¼–è¾‘ */
      border: 1px solid #7B61FF;
      border-radius: 4px;
      background: rgba(123, 97, 255, 0.1);
    }

    /* å°å›¾æ ‡æŒ‰é’® */
    .highlight-icon {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 16px;
      height: 16px;
      background: #7B61FF;
      border-radius: 50%;
      pointer-events: auto;  /* åªæœ‰å›¾æ ‡å¯ç‚¹å‡» */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #fff;
      transition: all 0.15s ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    .highlight-icon:hover {
      transform: scale(1.2);
      background: #5B41DF;
    }

    .highlight-overlay:hover {
      background: rgba(123, 97, 255, 0.15);
      border-color: #5B41DF;
    }

    /* å¼¹å‡ºèœå• */
    .variable-popup {
      position: absolute;
      background: #fff;
      border: 1px solid #e5e5e5;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px 0;
      z-index: 100;
      min-width: 150px;
    }

    .variable-popup-item {
      padding: 8px 16px;
      cursor: pointer;
      font-size: 14px;
    }

    .variable-popup-item:hover {
      background: #f5f5f5;
    }

    .variable-popup-header {
      padding: 8px 16px;
      font-size: 12px;
      color: #666;
      border-bottom: 1px solid #eee;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h2>è¦†ç›–å±‚æ–¹æ¡ˆ - å°å›¾æ ‡ç‚¹å‡»å¼¹çª—</h2>
  <p style="color: #666; font-size: 14px;">ç‚¹å‡»å˜é‡ä¸Šçš„å°å›¾æ ‡å¼¹å‡ºèœå•ï¼Œç‚¹å‡»æ–‡å­—å¯æ­£å¸¸ç¼–è¾‘</p>

  <div class="editor-container">
    <div id="overlays"></div>
    <div id="editor" contenteditable="true">å›å¤ç­–ç•¥
- åŸºäº {{product_data}} & {{faq_knowledge}} & {{common_knowledge}} å›å¤
- ä»…å½“å®Œå…¨æ— æ³•åŸºäºç°æœ‰æ•°æ®å›ç­”ç”¨æˆ·ä¸»è¦è¯‰æ±‚æ—¶è½¬äººå·¥ã€‚

**ç¦æ­¢ç¼–é€ æ•°æ®æºä¸­ä¸å­˜åœ¨çš„ä¿¡æ¯**
- åŸºäº {{product_data}} & {{faq_knowledge}} å›å¤...</div>
  </div>

  <script>
    const editor = document.getElementById('editor')
    const overlaysContainer = document.getElementById('overlays')
    const variablePattern = /\{\{(\w+)\}\}/g

    // å˜é‡æè¿°é…ç½®
    const variableDescriptions = {
      'product_data': {
        title: 'äº§å“æ•°æ®',
        description: 'åŒ…å«äº§å“åç§°ã€ä»·æ ¼ã€è§„æ ¼ç­‰ä¿¡æ¯çš„æ•°æ®æº',
        type: 'æ•°æ®æº'
      },
      'faq_knowledge': {
        title: 'FAQ çŸ¥è¯†åº“',
        description: 'å¸¸è§é—®é¢˜åŠç­”æ¡ˆçš„çŸ¥è¯†åº“ï¼Œç”¨äºå¿«é€Ÿå›ç­”ç”¨æˆ·é—®é¢˜',
        type: 'çŸ¥è¯†åº“'
      },
      'common_knowledge': {
        title: 'é€šç”¨çŸ¥è¯†',
        description: 'é€šç”¨é¢†åŸŸçŸ¥è¯†ï¼ŒåŒ…æ‹¬è¡Œä¸šæœ¯è¯­ã€åŸºç¡€æ¦‚å¿µç­‰',
        type: 'çŸ¥è¯†åº“'
      }
    }

    let currentPopup = null

    function showPopup(variableName, targetRect) {
      // å…³é—­å·²æœ‰å¼¹çª—
      hidePopup()

      const info = variableDescriptions[variableName] || {
        title: variableName,
        description: 'æš‚æ— æè¿°',
        type: 'å˜é‡'
      }

      const popup = document.createElement('div')
      popup.className = 'variable-popup'
      popup.innerHTML = `
        <div class="variable-popup-header">${info.type}</div>
        <div class="variable-popup-item" style="font-weight: 600; color: #7B61FF;">
          {{${variableName}}}
        </div>
        <div class="variable-popup-item" style="color: #333;">
          ${info.title}
        </div>
        <div class="variable-popup-item" style="color: #666; font-size: 12px;">
          ${info.description}
        </div>
        <div class="variable-popup-item" style="color: #7B61FF; border-top: 1px solid #eee; margin-top: 4px; padding-top: 8px;">
          ğŸ“‹ å¤åˆ¶å˜é‡
        </div>
        <div class="variable-popup-item" style="color: #e74c3c;">
          ğŸ—‘ï¸ åˆ é™¤å˜é‡
        </div>
      `

      // å®šä½å¼¹çª—
      const containerRect = document.querySelector('.editor-container').getBoundingClientRect()
      popup.style.left = (targetRect.left - containerRect.left) + 'px'
      popup.style.top = (targetRect.bottom - containerRect.top + 8) + 'px'

      document.querySelector('.editor-container').appendChild(popup)
      currentPopup = popup

      // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick)
      }, 0)
    }

    function hidePopup() {
      if (currentPopup) {
        currentPopup.remove()
        currentPopup = null
        document.removeEventListener('click', handleOutsideClick)
      }
    }

    function handleOutsideClick(e) {
      if (currentPopup && !currentPopup.contains(e.target) && !e.target.classList.contains('highlight-overlay')) {
        hidePopup()
      }
    }

    function updateOverlays() {
      // æ¸…é™¤æ—§çš„è¦†ç›–å±‚
      overlaysContainer.innerHTML = ''
      hidePopup()

      const text = editor.textContent || ''
      const editorRect = editor.getBoundingClientRect()

      // æ‰¾åˆ°æ‰€æœ‰å˜é‡çš„ä½ç½®
      let match
      const regex = /\{\{(\w+)\}\}/g
      while ((match = regex.exec(text)) !== null) {
        const start = match.index
        const end = start + match[0].length
        const variableName = match[1]  // æå–å˜é‡å

        // åˆ›å»º Range è·å–ä½ç½®
        const range = createRangeFromTextOffset(editor, start, end)
        if (!range) continue

        // è·å– Range çš„ä½ç½®ï¼ˆå¯èƒ½è·¨å¤šè¡Œï¼Œè¿”å›å¤šä¸ªçŸ©å½¢ï¼‰
        const rects = range.getClientRects()

        for (const rect of rects) {
          // åˆ›å»ºè¦†ç›–å±‚å…ƒç´ 
          const overlay = document.createElement('div')
          overlay.className = 'highlight-overlay'
          overlay.dataset.variable = variableName
          overlay.style.left = (rect.left - editorRect.left + editor.offsetLeft) + 'px'
          overlay.style.top = (rect.top - editorRect.top + editor.offsetTop) + 'px'
          overlay.style.width = rect.width + 'px'
          overlay.style.height = rect.height + 'px'

          // åˆ›å»ºå°å›¾æ ‡ï¼ˆåªæœ‰å›¾æ ‡å¯ç‚¹å‡»ï¼‰
          const icon = document.createElement('div')
          icon.className = 'highlight-icon'
          icon.innerHTML = 'i'
          icon.addEventListener('click', (e) => {
            e.stopPropagation()
            showPopup(variableName, rect)
          })

          overlay.appendChild(icon)
          overlaysContainer.appendChild(overlay)
        }
      }
    }

    // æ ¹æ®æ–‡æœ¬åç§»é‡åˆ›å»º Range
    function createRangeFromTextOffset(root, start, end) {
      const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT)
      let currentOffset = 0
      let startNode = null, startOffset = 0
      let endNode = null, endOffset = 0

      while (walker.nextNode()) {
        const node = walker.currentNode
        const nodeLength = node.textContent.length

        if (!startNode && currentOffset + nodeLength > start) {
          startNode = node
          startOffset = start - currentOffset
        }

        if (!endNode && currentOffset + nodeLength >= end) {
          endNode = node
          endOffset = end - currentOffset
          break
        }

        currentOffset += nodeLength
      }

      if (startNode && endNode) {
        const range = new Range()
        range.setStart(startNode, startOffset)
        range.setEnd(endNode, endOffset)
        return range
      }
      return null
    }

    // åˆå§‹åŒ–
    updateOverlays()

    // ç›‘å¬è¾“å…¥
    editor.addEventListener('input', updateOverlays)

    // ç›‘å¬æ»šåŠ¨ï¼ˆå¦‚æœç¼–è¾‘å™¨å¯æ»šåŠ¨ï¼‰
    editor.addEventListener('scroll', updateOverlays)

    // ç›‘å¬çª—å£å˜åŒ–
    window.addEventListener('resize', updateOverlays)
  </script>
</body>
</html>
